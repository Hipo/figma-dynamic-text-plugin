<style type="text/css">
    .font-custom-select {
        width: 468px;
        height: 40px;
        margin-bottom: 10px;
        border: 1px solid #D7D7D7;
        border-radius: 0;
        background: #ffffff;
    }

    .container {
        display: flex;
        flex-flow: row wrap;
    }

    .button {
        background-color: #20C17E;
        border: none;
        color: white;
        padding: 15px 25px;
        text-align: center;
        font-size: 14px;
        cursor: pointer;
    }

    .usage-list {
        margin-left: 10px;
        margin-right: 10px;
        width: 468px;
        height: 10px;
        overflow-y: scroll;
    }
</style>

<select id="font-options" class="font-custom-select"></select>
<select id="font-weights" class="font-custom-select"></select>
<select id="font-sizes" class="font-custom-select"></select>

<button id="run_script" class="button">Run Script</button>

<p id="usage-text"></p>

<ul id="usage-list">
</ul>

<script>
    var textNodes = [];
    var availableFontNames = [];
    var availableFontWeights = [];
    var availableFontSizes = [];

    function filterTextNodes(fontName, fontWeight, fontSize) {
        var usageList = document.getElementById("usage-list");
        usageList.innerHTML = '';
        var filteredTextNodes = textNodes.filter(function (node) {
            if (fontName && node.fontName != fontName) {
                return false;
            }
            if (fontWeight && node.fontWeight != fontWeight) {
                return false;
            }
            if (fontSize && node.fontSize != fontSize) {
                return false;
            }
            var listItem = document.createElement("li");
            console.log(node)
            listItem.appendChild(document.createTextNode(node.id + " - " +node.characters));
            usageList.appendChild(listItem);
            return true;
        });
        document.getElementById("usage-text").innerHTML = filteredTextNodes.length + " Usage";
        parent.postMessage({ pluginMessage: { type: 'create-new-style', filteredTextNodes } }, '*')
        console.log(filteredTextNodes);
    }

    document.getElementById('run_script').addEventListener('click', function () {
        var selectFonts = document.getElementById("font-options");
        var selectedFont = selectFonts.options[selectFonts.selectedIndex].value;
        var selectFontWeights = document.getElementById("font-weights");
        var selectedFontWeight = selectFontWeights.options[selectFontWeights.selectedIndex].value;
        var selectSizes = document.getElementById("font-sizes");
        var selectedSize = selectSizes.options[selectSizes.selectedIndex].value;
        filterTextNodes(selectedFont, selectedFontWeight, selectedSize)
    })

    onmessage = (e) => {
        var msg = event.data.pluginMessage;
        console.log(msg);

        if (msg.type == "initUI") {
            textNodes = msg.textNodes;
            fontNamesByUsage = msg.fontNamesByUsage;
            availableFontWeights = msg.availableFontWeights;
            availableFontSizes = msg.availableFontSizes;

            console.log(fontNamesByUsage);
            console.log(availableFontWeights);
            console.log(availableFontSizes);

            Object.keys(fontNamesByUsage).forEach(element => {
                if (element != null) {
                    var option = document.createElement("option");
                    option.text = element + " " + fontNamesByUsage[element];
                    option.value = element;
                    document.getElementById('font-options').appendChild(option);
                }
            });

            availableFontWeights.forEach(element => {
                if (element != null) {
                    var option = document.createElement("option");
                    option.text = element;
                    option.value = element;
                    document.getElementById('font-weights').appendChild(option);
                }
            });
            availableFontSizes.forEach(element => {
                if (element != null) {
                    var option = document.createElement("option");
                    option.text = element;
                    option.value = element;
                    document.getElementById('font-sizes').appendChild(option);
                }
            });
        }
    }
</script>