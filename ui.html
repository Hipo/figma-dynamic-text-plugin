<style type="text/css">
    .font-custom-select {
        width: 468px;
        height: 40px;
        margin-bottom: 10px;
        border: 1px solid #D7D7D7;
        border-radius: 0;
        background: #ffffff;
    }

    .style-custom-select {
        width: 140px;
        height: 40px;
        margin-bottom: 10px;
        border: 1px solid #D7D7D7;
        border-radius: 0;
        background: #ffffff;
    }

    .container {
        display: flex;
        flex-flow: row wrap;
    }

    .button {
        background-color: #20C17E;
        border: none;
        color: white;
        padding: 15px 25px;
        text-align: center;
        font-size: 14px;
        cursor: pointer;
    }

    .usage-list {
        margin-left: 10px;
        margin-right: 10px;
        width: 468px;
        height: 10px;
        overflow-y: scroll;
    }

    hr {
        display: block;
        height: 1px;
        border: 0;
        border-top: 1px solid #E1E1E1;
        margin: 1em 0;
        padding: 0;
    }

    .linkedList{
        color: #2091C1;
    }

    .usage-text {
        color: #20C17E;
        font-weight: bold;
    }


    .table {
        display:table;
        width:100%;
    }
    .table-row {
        display:table-row;
    }
    .left-align {
        display:table-cell;
        width:25%;
    }
    .right-align {
        display:table-cell;
        text-align:right;
    }
</style>

<select id="font-options" class="font-custom-select" onchange="getSelectedFontsAndSendToFilter()"></select>
<select id="font-weights" class="font-custom-select" onchange="getSelectedFontsAndSendToFilter()"></select>
<select id="font-sizes" class="font-custom-select" onchange="getSelectedFontsAndSendToFilter()"></select>

<hr/>
<div class="table">
    <div class="table-row">
        <div class="left-align">
            <p id="usage-text" hidden="hidden" class="usage-text"></p>
        </div>
        <div class="right-align">
            <button id="run_script" class="button" onclick="onRunScriptClick()">Run Script</button>
            <select id="style-spinner" class="style-custom-select" hidden="hidden"></select>
        </div>
    </div>
</div>
<hr/>
<ul id="usage-list">
</ul>

<script>
    var textNodes = [];
    var availableFontNames = [];
    var availableFontWeights = [];
    var availableFontSizes = [];
    var availableTextStyles = [];

    function filterTextNodes(fontName, fontWeight, fontSize) {
        var usageList = document.getElementById("usage-list");
        usageList.innerHTML = '';
        var filteredTextNodes = textNodes.filter(function (node) {
            if (fontName && node.fontName != fontName) {
                return false;
            }
            if (fontWeight && node.fontWeight != fontWeight) {
                return false;
            }
            if (fontSize && node.fontSize != fontSize) {
                return false;
            }
            var listItem = document.createElement("li");
            console.log(node)
            listItem.appendChild(document.createTextNode(node.id + " - " +node.characters));
            listItem.className = "linkedList"
            listItem.setAttribute("id", node.id);
            usageList.appendChild(listItem);
            return true;
        });

        usageList.addEventListener("click",function(e) {
            if (e.target && e.target.matches("li")) {
                onTextNodeClick(e.target.id.toString())
            }
        });
        document.getElementById("usage-text").innerHTML = filteredTextNodes.length + " Usage";
        // parent.postMessage({ pluginMessage: { type: 'create-new-style', filteredTextNodes } }, '*')
        console.log(filteredTextNodes);
    }

    function onTextNodeClick(selectedNodeId) {
        parent.postMessage({pluginMessage: {type: 'focus-on-selected-node', selectedNodeId} }, '*' )
    }

    function onRunScriptClick() {
        document.getElementById("run_script").hidden = true;
        document.getElementById("usage-text").hidden = false;
        document.getElementById("style-spinner").hidden = false;
        getSelectedFontsAndSendToFilter()
    }

    function getSelectedFontsAndSendToFilter() {
        var selectFonts = document.getElementById("font-options");
        var selectedFont = selectFonts.options[selectFonts.selectedIndex].value;
        var selectFontWeights = document.getElementById("font-weights");
        var selectedFontWeight = selectFontWeights.options[selectFontWeights.selectedIndex].value;
        var selectSizes = document.getElementById("font-sizes");
        var selectedSize = selectSizes.options[selectSizes.selectedIndex].value;
        filterTextNodes(selectedFont, selectedFontWeight, selectedSize)
    }

    onmessage = (e) => {
        var msg = event.data.pluginMessage;
        console.log(msg);

        if (msg.type == "initUI") {
            textNodes = msg.textNodes;
            fontNamesByUsage = msg.fontNamesByUsage;
            availableFontWeights = msg.availableFontWeights;
            availableFontSizes = msg.availableFontSizes;
            availableTextStyles = msg.availableTextStyles;

            console.log(fontNamesByUsage);
            console.log(availableFontWeights);
            console.log(availableFontSizes);
            console.log(availableTextStyles);

            Object.keys(fontNamesByUsage).forEach(element => {
                if (element != null) {
                    var text = element + " " + fontNamesByUsage[element];
                    createOptionAndAddToSelector(text, element, 'font-options')
                }
            });

            availableFontWeights.forEach(element => {
                if (element != null) {
                    createOptionAndAddToSelector(element, element, 'font-weights');
                }
            });
            availableFontSizes.forEach(element => {
                if (element != null) {
                    createOptionAndAddToSelector(element, element, 'font-sizes');
                }
            });

            createOptionAndAddToSelector("+ Create New", "create-new", 'style-spinner');
            availableTextStyles.forEach(element => {
                if( element != null){
                    createOptionAndAddToSelector(element.name, element.id, 'style-spinner');
                }
            })
        }

        function createOptionAndAddToSelector(text, value, selectorName) {
            var option = document.createElement("option");
            option.text = text;
            option.value = value;
            document.getElementById(selectorName).appendChild(option);
        }
    }
</script>