<style type="text/css">
    .font-custom-select {
        width: 468px;
        height: 40px;
        margin-bottom: 10px;
        border: 1px solid #D7D7D7;
        border-radius: 0;
        background: #ffffff;
    }

    .style-custom-select {
        width: 140px;
        height: 40px;
        margin-bottom: 10px;
        border: 1px solid #D7D7D7;
        border-radius: 0;
        background: #ffffff;
    }

    .container {
        display: flex;
        flex-flow: row wrap;
    }

    .button {
        background-color: #20C17E;
        border: none;
        color: white;
        padding: 15px 25px;
        text-align: center;
        font-size: 14px;
        cursor: pointer;
    }

    .usage-list {
        margin-left: 10px;
        margin-right: 10px;
        width: 468px;
        height: 10px;
        overflow-y: scroll;
    }

    hr {
        display: block;
        height: 1px;
        border: 0;
        border-top: 1px solid #E1E1E1;
        margin: 1em 0;
        padding: 0;
    }

    .linkedList {
        color: #2091C1;
        list-style-type: none;
        margin: 10px 0;
        cursor: pointer;
    }

    .usage-text {
        color: #20C17E;
        font-weight: bold;
        padding-left: 40px;
    }


    .table {
        display: table;
        width: 100%;
    }

    .table-row {
        display: table-row;
    }

    .left-align {
        display: table-cell;
        width: 25%;
    }

    .right-align {
        display: table-cell;
        text-align: right;
    }

    /* The Modal (background) */
    .modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1; /* Sit on top */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgb(0, 0, 0); /* Fallback color */
        background-color: rgba(0, 0, 0, 0.4); /* Black w/ opacity */
        -webkit-animation-name: fadeIn; /* Fade in the background */
        -webkit-animation-duration: 0.4s;
        animation-name: fadeIn;
        animation-duration: 0.4s
    }

    /* Modal Content */
    .modal-content {
        position: fixed;
        bottom: 0;
        background-color: #fefefe;
        width: 100%;
        -webkit-animation-name: slideIn;
        -webkit-animation-duration: 0.4s;
        animation-name: slideIn;
        animation-duration: 0.4s
    }

    /* The Close Button */
    .close {
        color: #CECECE;
        float: right;
        font-size: 36px;
        cursor: pointer;
        text-decoration: none;
    }

    .modal-header {
        padding: 2px 16px;
        color: black;
        font-size: 14px;
    }

    .modal-body {
        padding: 16px;
    }

    .dialog-left-align {
        display: table-cell;
        width: 344px;
    }

    .dialog-right-align {
        display: table-cell;
        text-align: right;
        width: 140px;
    }

    .style-input-field {
        width: 295px;
        height: 40px;
        padding-left: 10px;
    }

    /* Add Animation */
    @-webkit-keyframes slideIn {
        from {
            bottom: -300px;
            opacity: 0
        }
        to {
            bottom: 0;
            opacity: 1
        }
    }

    @keyframes slideIn {
        from {
            bottom: -300px;
            opacity: 0
        }
        to {
            bottom: 0;
            opacity: 1
        }
    }

    @-webkit-keyframes fadeIn {
        from {
            opacity: 0
        }
        to {
            opacity: 1
        }
    }

    @keyframes fadeIn {
        from {
            opacity: 0
        }
        to {
            opacity: 1
        }
    }
</style>

<select id="font-options" class="font-custom-select" onchange="getSelectedFontsAndSendToFilter()"></select>
<select id="font-weights" class="font-custom-select" onchange="getSelectedFontsAndSendToFilter()"></select>
<select id="font-sizes" class="font-custom-select" onchange="getSelectedFontsAndSendToFilter()"></select>

<hr/>
<div class="table">
    <div class="table-row">
        <div class="left-align">
            <p id="usage-text" hidden="hidden" class="usage-text"></p>
        </div>
        <div class="right-align">
            <button id="run_script" class="button" onclick="onRunScriptClick()">Run Script</button>
            <select id="style-spinner" class="style-custom-select" hidden="hidden" onchange="onStyleSelectorChanged()"></select>
        </div>
    </div>
</div>

<!-- The Modal -->
<div id="bottomModal" class="modal">

    <!-- Modal content -->
    <div class="modal-content">
        <div class="modal-header">
            <span class="close">&times;</span>
            <p id="modal-header-text"></p>
        </div>
        <div class="modal-body">
            <div class="table">
                <div class="table-row">
                    <div class="dialog-left-align">
                        <input id="style-name-input-field" type="text" class="style-input-field" hidden="hidden">
                    </div>
                    <div class="dialog-right-align">
                        <button id="confirm-button" class="button">Confirm</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
<hr/>
<ul id="usage-list">
</ul>

<script>
    var textNodes = [];
    var availableFontNames = [];
    var availableFontWeights = [];
    var availableFontSizes = [];
    var availableTextStyles = [];
    let filteredTextNodes = [];

    function filterTextNodes(fontName, fontWeight, fontSize) {
        var usageList = document.getElementById("usage-list");
        usageList.innerHTML = '';
        filteredTextNodes = [];
        filteredTextNodes = textNodes.filter(function (node) {
            if (fontName && node.fontName != fontName) {
                return false;
            }
            if (fontWeight && node.fontWeight != fontWeight) {
                return false;
            }
            if (fontSize && node.fontSize != fontSize) {
                return false;
            }
            var listItem = document.createElement("li");
            console.log(node)
            listItem.appendChild(document.createTextNode(node.characters));
            listItem.className = "linkedList";
            listItem.setAttribute("id", node.id);
            usageList.appendChild(listItem);
            return true;
        });

        usageList.addEventListener("click", function (e) {
            if (e.target && e.target.matches("li")) {
                onTextNodeClick(e.target.id.toString())
            }
        });
        document.getElementById("usage-text").innerHTML = filteredTextNodes.length + " Usage";
        // parent.postMessage({ pluginMessage: { type: 'create-new-style', filteredTextNodes } }, '*')
        console.log(filteredTextNodes);
    }

    function onTextNodeClick(selectedNodeId) {
        parent.postMessage({pluginMessage: {type: 'focus-on-selected-node', selectedNodeId}}, '*')
    }

    function onRunScriptClick() {
        document.getElementById("run_script").hidden = true;
        document.getElementById("usage-text").hidden = false;
        document.getElementById("style-spinner").hidden = false;
        getSelectedFontsAndSendToFilter()
    }

    function onStyleSelectorChanged() {
        let CREATE_NEW_STYLE_INDEX = 1;
        let styleSelector = document.getElementById("style-spinner");
        let selectedIndex = styleSelector.selectedIndex;
        if (selectedIndex > 0) {
            if (selectedIndex === CREATE_NEW_STYLE_INDEX) {
                // let styleId = styleSelector.options[selectedIndex].value;
                // parent.postMessage({pluginMessage: {type: 'create-new-style', filteredTextNodes, styleId}}, '*')
                let modalText = prepareBottomModalText("", filteredTextNodes.length, true);
                showBottomModal(modalText, 0, true)
            } else {
                let modalText = prepareBottomModalText(styleSelector.options[selectedIndex].text, filteredTextNodes.length, false);
                showBottomModal(modalText, styleSelector.options[selectedIndex].value, false)
            }
        }
    }
    
    function prepareBottomModalText(subtext, itemCount, isCreateNewStyle) {
        if (isCreateNewStyle){
            // it automatically trims, need to add spaces as separate.
            return "We will create a New Style for all" + " " + itemCount + " " + "texts";
        } else {
            // it automatically trims, need to add spaces as separate.
            return "All" + " " + itemCount + " " + "texts will be converted to " + subtext + " " + "text style";
        }
    }

    function showBottomModal(text, styleId, isCreateNewStyle) {
        let modal = document.getElementById("bottomModal");
        let confirmButton = document.getElementById("confirm-button");
        let closeButton = document.getElementsByClassName("close")[0];
        let modalHeaderText = document.getElementById("modal-header-text");

        modalHeaderText.textContent = text;

        closeButton.onclick = function() {
            modal.style.display = "none";
        };

        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        };

        // TODO add onClick for confirm button that triggers postMessage

        confirmButton.addEventListener('click', function () {
            if (isCreateNewStyle){
                let newStyleName = document.getElementById('style-name-input-field').value;
                parent.postMessage({pluginMessage: {type: 'create-new-style', filteredTextNodes, newStyleName}}, '*')
            } else {
                parent.postMessage({pluginMessage: {type: 'assign-to-selected-style', filteredTextNodes, styleId}}, '*')
            }
            modal.style.display = "none";
        });

        document.getElementById('style-name-input-field').hidden = !isCreateNewStyle;

        modal.style.display = "block";
    }

    function getSelectedFontsAndSendToFilter() {
        var selectFonts = document.getElementById("font-options");
        var selectedFont = selectFonts.options[selectFonts.selectedIndex].value;
        var selectFontWeights = document.getElementById("font-weights");
        var selectedFontWeight = selectFontWeights.options[selectFontWeights.selectedIndex].value;
        var selectSizes = document.getElementById("font-sizes");
        var selectedSize = selectSizes.options[selectSizes.selectedIndex].value;
        filterTextNodes(selectedFont, selectedFontWeight, selectedSize)
    }

    onmessage = (e) => {
        var msg = event.data.pluginMessage;
        console.log(msg);

        if (msg.type == "initUI") {
            textNodes = msg.textNodes;
            fontNamesByUsage = msg.fontNamesByUsage;
            availableFontWeights = msg.availableFontWeights;
            availableFontSizes = msg.availableFontSizes;
            availableTextStyles = msg.availableTextStyles;

            console.log(fontNamesByUsage);
            console.log(availableFontWeights);
            console.log(availableFontSizes);
            console.log(availableTextStyles);

            Object.keys(fontNamesByUsage).forEach(element => {
                if (element != null) {
                    var text = element + " " + fontNamesByUsage[element];
                    createOptionAndAddToSelector(text, element, 'font-options')
                }
            });

            availableFontWeights.forEach(element => {
                if (element != null) {
                    createOptionAndAddToSelector(element, element, 'font-weights');
                }
            });
            availableFontSizes.forEach(element => {
                if (element != null) {
                    createOptionAndAddToSelector(element, element, 'font-sizes');
                }
            });

            createOptionAndAddToSelector("Style", "undefined", 'style-spinner');
            createOptionAndAddToSelector("+ Create New", "create-new", 'style-spinner');
            availableTextStyles.forEach(element => {
                if (element != null) {
                    createOptionAndAddToSelector(element.name, element.id, 'style-spinner');
                }
            })
        }

        function createOptionAndAddToSelector(text, value, selectorName) {
            var option = document.createElement("option");
            option.text = text;
            option.value = value;
            document.getElementById(selectorName).appendChild(option);
        }
    }
</script>